import { supabase } from './supabase';

export interface RestaurantData {
  id: string;
  name: string;
  slug: string;
  email: string;
  phone: string;
  website: string;
  tagline: string;
  description: string;
  address: string;
  city: string;
  state: string;
  zip_code: string;
  country: string;
}

export interface LocationData {
  id: string;
  restaurant_id: string;
  name: string;
  address: string;
  city: string;
  state: string;
  zip_code: string;
  phone: string;
  email: string;
  is_active: boolean;
  business_hours: any;
}

// Load restaurant settings from database
export async function loadRestaurantSettings(userId: string) {
  try {
    // Get user's restaurant
    const { data: staffData, error: staffError } = await supabase
      .from('staff')
      .select('restaurant_id')
      .eq('user_id', userId)
      .single();

    if (staffError || !staffData) {
      throw new Error('Restaurant not found for user');
    }

    const restaurantId = staffData.restaurant_id;

    // Load restaurant data
    const { data: restaurant, error: restaurantError } = await supabase
      .from('restaurants')
      .select('*')
      .eq('id', restaurantId)
      .single();

    if (restaurantError) throw restaurantError;

    // Load locations
    const { data: locations, error: locationsError } = await supabase
      .from('locations')
      .select('*')
      .eq('restaurant_id', restaurantId)
      .order('created_at', { ascending: true });

    if (locationsError) throw locationsError;

    return {
      restaurant: restaurant as RestaurantData,
      locations: locations as LocationData[],
      restaurantId
    };
  } catch (error) {
    console.error('Error loading settings:', error);
    throw error;
  }
}

// Save restaurant settings (UPDATE only, no INSERT)
export async function saveRestaurantSettings(
  restaurantId: string,
  data: {
    businessInfo: Partial<RestaurantData>;
    locations: LocationData[];
  }
) {
  try {
    // Create audit log entry
    await createAuditLog(restaurantId, 'settings_update', {
      changed_fields: Object.keys(data.businessInfo),
      timestamp: new Date().toISOString()
    });

    // Update restaurant info
    const { error: restaurantError } = await supabase
      .from('restaurants')
      .update({
        name: data.businessInfo.name,
        email: data.businessInfo.email,
        phone: data.businessInfo.phone,
        website: data.businessInfo.website,
        tagline: data.businessInfo.tagline,
        description: data.businessInfo.description,
        updated_at: new Date().toISOString()
      })
      .eq('id', restaurantId);

    if (restaurantError) throw restaurantError;

    // Update each location (don't delete and recreate)
    for (const location of data.locations) {
      if (location.id.startsWith('new-')) {
        // Insert new location
        const { error } = await supabase
          .from('locations')
          .insert({
            restaurant_id: restaurantId,
            name: location.name,
            address: location.address,
            city: location.city,
            state: location.state,
            zip_code: location.zip_code,
            phone: location.phone,
            email: location.email,
            is_active: location.is_active,
            business_hours: location.business_hours
          });
        if (error) throw error;
      } else {
        // Update existing location
        const { error } = await supabase
          .from('locations')
          .update({
            name: location.name,
            address: location.address,
            city: location.city,
            state: location.state,
            zip_code: location.zip_code,
            phone: location.phone,
            email: location.email,
            is_active: location.is_active,
            business_hours: location.business_hours,
            updated_at: new Date().toISOString()
          })
          .eq('id', location.id);
        if (error) throw error;
      }
    }

    return { success: true };
  } catch (error) {
    console.error('Error saving settings:', error);
    throw error;
  }
}

// Delete location with confirmation
export async function deleteLocation(locationId: string, restaurantId: string) {
  try {
    // Create audit log before deletion
    await createAuditLog(restaurantId, 'location_delete', {
      location_id: locationId,
      timestamp: new Date().toISOString()
    });

    // Soft delete (set is_active to false) instead of hard delete
    const { error } = await supabase
      .from('locations')
      .update({ is_active: false, updated_at: new Date().toISOString() })
      .eq('id', locationId);

    if (error) throw error;

    return { success: true };
  } catch (error) {
    console.error('Error deleting location:', error);
    throw error;
  }
}

// Create audit log entry
async function createAuditLog(restaurantId: string, action: string, details: any) {
  try {
    // Get current user
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) return;

    // Insert audit log (table needs to be created)
    await supabase
      .from('audit_logs')
      .insert({
        restaurant_id: restaurantId,
        user_id: user.id,
        action,
        details,
        created_at: new Date().toISOString()
      });
  } catch (error) {
    // Don't throw error if audit logging fails
    console.error('Audit log error:', error);
  }
}
